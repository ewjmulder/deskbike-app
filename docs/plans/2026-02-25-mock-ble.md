# Software BLE Mock Implementation Plan

> **Status update (2026-02-27):** Historical implementation plan.
> Software mock mode is implemented, but this plan references older module names and wiring.
> Current source of truth: `docs/Architecture.md` and `src/main/ble/mock-helper.ts`.


> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add `MOCK_BLE=1` mode that feeds synthetic CSC data into the existing IPC pipeline without any Bluetooth hardware.

**Architecture:** A new `src/main/ble/mock.ts` module exports the same `startScan`/`stopScan`/`connect`/`disconnect` API as the real BLE modules. `handlers.ts` picks the real or mock module based on `process.env.MOCK_BLE`. The renderer and the rest of `handlers.ts` are untouched.

**Tech Stack:** TypeScript, Vitest (fake timers for interval tests), Node.js `Buffer`.

---

### Task 1: Write tests for `mock.ts`

**Files:**
- Create: `tests/ble/mock.test.ts`

**Step 1: Write the failing test file**

```ts
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest'

// Dynamic import lets us import the module after vi.useFakeTimers()
describe('mock BLE module', () => {
  beforeEach(() => {
    vi.useFakeTimers()
  })

  afterEach(() => {
    vi.useRealTimers()
  })

  it('startScan calls onFound immediately with a mock device', async () => {
    const { startScan, stopScan } = await import('../../src/main/ble/mock')
    const onFound = vi.fn()
    startScan(onFound)
    expect(onFound).toHaveBeenCalledOnce()
    expect(onFound).toHaveBeenCalledWith({
      id: 'mock-0',
      name: 'DeskBike-MOCK',
      address: '00:00:00:00:00:00'
    })
    stopScan()
  })

  it('connect emits a Buffer packet after 1000ms', async () => {
    const { connect, disconnect } = await import('../../src/main/ble/mock')
    const onData = vi.fn()
    const onDisconnect = vi.fn()

    await connect('mock-0', onData, onDisconnect)
    expect(onData).not.toHaveBeenCalled()

    vi.advanceTimersByTime(1000)
    expect(onData).toHaveBeenCalledOnce()

    const [sensorId, buf] = onData.mock.calls[0]
    expect(sensorId).toBe('mock-0')
    expect(buf).toBeInstanceOf(Buffer)
    expect(buf.length).toBe(11)
    expect(buf[0]).toBe(0x03) // flags: wheel + crank

    await disconnect('mock-0')
  })

  it('connect emits multiple packets over time', async () => {
    const { connect, disconnect } = await import('../../src/main/ble/mock')
    const onData = vi.fn()
    await connect('mock-0', onData, vi.fn())

    vi.advanceTimersByTime(3000)
    expect(onData).toHaveBeenCalledTimes(3)

    await disconnect('mock-0')
  })

  it('disconnect stops packet emission and calls onDisconnect', async () => {
    const { connect, disconnect } = await import('../../src/main/ble/mock')
    const onData = vi.fn()
    const onDisconnect = vi.fn()

    await connect('mock-0', onData, onDisconnect)
    vi.advanceTimersByTime(1000)
    expect(onData).toHaveBeenCalledTimes(1)

    await disconnect('mock-0')
    expect(onDisconnect).toHaveBeenCalledWith('mock-0')

    vi.advanceTimersByTime(2000)
    expect(onData).toHaveBeenCalledTimes(1) // no new packets after disconnect
  })
})
```

**Step 2: Run tests to verify they fail**

```bash
pnpm test tests/ble/mock.test.ts
```

Expected: all 4 tests fail with "Cannot find module '../../src/main/ble/mock'"

---

### Task 2: Implement `src/main/ble/mock.ts`

**Files:**
- Create: `src/main/ble/mock.ts`

**Step 1: Implement the module**

```ts
import type { DiscoveredDevice } from './scanner'
import type { DataHandler, DisconnectHandler } from './connection'

const MOCK_DEVICE: DiscoveredDevice = {
  id: 'mock-0',
  name: 'DeskBike-MOCK',
  address: '00:00:00:00:00:00'
}

const INTERVAL_MS = 1000
const WHEEL_CIRCUMFERENCE_M = 2.1

let wheelRevs = 0.0
let wheelTimeTicks = 0.0
let crankRevs = 0.0
let crankTimeTicks = 0.0

function buildPacket(): Buffer {
  const dt = INTERVAL_MS / 1000
  const phase = ((Date.now() % 60_000) / 60_000) * 2 * Math.PI

  const speedKmh = 17.5 + 2.5 * Math.sin(phase)   // 15–20 km/h
  const cadenceRpm = 70 + 5 * Math.cos(phase)      // 65–75 RPM

  wheelRevs += (speedKmh / 3.6 / WHEEL_CIRCUMFERENCE_M) * dt
  wheelTimeTicks += dt * 1024

  crankRevs += (cadenceRpm / 60) * dt
  crankTimeTicks += dt * 1024

  const buf = Buffer.alloc(11)
  buf.writeUInt8(0x03, 0)
  buf.writeUInt32LE(Math.round(wheelRevs) >>> 0, 1)
  buf.writeUInt16LE(Math.round(wheelTimeTicks) & 0xffff, 5)
  buf.writeUInt16LE(Math.round(crankRevs) & 0xffff, 7)
  buf.writeUInt16LE(Math.round(crankTimeTicks) & 0xffff, 9)

  return buf
}

const timers = new Map<string, ReturnType<typeof setInterval>>()

export function startScan(onFound: (device: DiscoveredDevice) => void): void {
  onFound(MOCK_DEVICE)
}

export function stopScan(): void {
  // no-op
}

export async function connect(
  deviceId: string,
  onData: DataHandler,
  onDisconnect: DisconnectHandler
): Promise<void> {
  const timer = setInterval(() => {
    onData(deviceId, buildPacket())
  }, INTERVAL_MS)
  timers.set(deviceId, timer)
}

export async function disconnect(deviceId: string): Promise<void> {
  const timer = timers.get(deviceId)
  if (timer) {
    clearInterval(timer)
    timers.delete(deviceId)
  }
}
```

**Step 2: Run tests to verify they pass**

```bash
pnpm test tests/ble/mock.test.ts
```

Expected: all 4 tests pass

**Step 3: Run all tests to verify nothing is broken**

```bash
pnpm test
```

Expected: all existing tests still pass

**Step 4: Commit**

```bash
git add src/main/ble/mock.ts tests/ble/mock.test.ts
git commit -m "feat: add software BLE mock module (MOCK_BLE=1)"
```

---

### Task 3: Wire mock into `handlers.ts`

**Files:**
- Modify: `src/main/ipc/handlers.ts`

**Step 1: Replace static imports with conditional dynamic imports**

Replace the top of [handlers.ts](src/main/ipc/handlers.ts) (lines 1–5):

```ts
// Before:
import { ipcMain, BrowserWindow } from 'electron'
import { startScan, stopScan } from '../ble/scanner'
import { connect, disconnect } from '../ble/connection'
import { insertMeasurement } from '../db/queries'
```

With:

```ts
import { ipcMain, BrowserWindow } from 'electron'
import { insertMeasurement } from '../db/queries'
import type { DiscoveredDevice } from '../ble/scanner'
import type { DataHandler, DisconnectHandler } from '../ble/connection'

const MOCK = process.env.MOCK_BLE === '1'

const { startScan, stopScan }: {
  startScan: (onFound: (device: DiscoveredDevice) => void) => void
  stopScan: () => void
} = MOCK ? require('../ble/mock') : require('../ble/scanner')

const { connect, disconnect }: {
  connect: (deviceId: string, onData: DataHandler, onDisconnect: DisconnectHandler) => Promise<void>
  disconnect: (deviceId: string) => Promise<void>
} = MOCK ? require('../ble/mock') : require('../ble/connection')
```

Note: `require()` instead of `await import()` because `registerIpcHandlers` is synchronous and top-level `await` is not available here. Both modules are always present in the build.

**Step 2: Verify TypeScript compiles**

```bash
pnpm build 2>&1 | head -30
```

Expected: no TypeScript errors, build succeeds

**Step 3: Manual smoke test — mock mode**

```bash
MOCK_BLE=1 pnpm dev
```

1. App opens → click **Scan**
2. Device `DeskBike-MOCK` appears in the list
3. Click **Connect**
4. "Live data" section appears and packet count increments every second
5. Raw bytes start with `03` (flags: wheel + crank data)

**Step 4: Manual smoke test — real mode**

```bash
pnpm dev
```

Expected: app behaves exactly as before (scans for real BLE devices)

**Step 5: Commit**

```bash
git add src/main/ipc/handlers.ts
git commit -m "feat: activate software BLE mock via MOCK_BLE=1 env var"
```

---

### Task 4: Document in CLAUDE.md

**Files:**
- Modify: `CLAUDE.md`

**Step 1: Add mock mode to the Commands section**


```markdown
MOCK_BLE=1 pnpm dev  # Start with software BLE mock (no hardware needed)
```



```markdown
**Software mock (no hardware):** `MOCK_BLE=1 pnpm dev` starts the app with a built-in mock that emits synthetic CSC packets every second (15–20 km/h, 65–75 RPM). The mock device appears as `DeskBike-MOCK` in the scan results.
```

**Step 3: Commit**

```bash
git add CLAUDE.md
git commit -m "docs: document MOCK_BLE=1 software mock in CLAUDE.md"
```
